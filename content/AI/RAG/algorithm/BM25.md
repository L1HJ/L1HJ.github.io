# BM25 算法笔记

## 1. 引言
在向量检索普及之前，传统搜索引擎主要依赖 **基于词项的检索方法**。  
**BM25 (Best Match 25)** 是一种经典的 **概率信息检索模型**，至今仍被广泛应用于搜索引擎、问答系统、稀疏检索（如 ElasticSearch、Lucene）中。  

它的核心思想是：  
- 如果一个文档包含更多的查询词，它更相关  
- 如果查询词在文档中出现频率过高，额外提升效果会减弱（饱和效应）  
- 较短的文档更可能与查询相关（长度归一化）

---

## 2. BM25 公式

BM25 的打分公式如下：

$$
\text{score}(q, D) = \sum_{t \in q} IDF(t) \cdot \frac{f(t, D) \cdot (k_1 + 1)}{f(t, D) + k_1 \cdot \left(1 - b + b \cdot \frac{|D|}{\text{avgdl}}\right)}
$$

其中：
- $q$：查询  
- $D$：文档  
- $t$：查询词  
- $f(t, D)$：词项 $t$ 在文档 $D$ 中的词频 (TF)  
- $|D|$：文档长度（词数）  
- $\text{avgdl}$：语料库中文档的平均长度  
- $k_1$：控制 TF 饱和程度的超参数（常用 1.2～2.0）  
- $b$：控制长度归一化的超参数（常用 0.75）  
- $IDF(t)$：逆文档频率  

$$
IDF(t) = \log \frac{N - n_t + 0.5}{n_t + 0.5}
$$

其中：
- $N$：文档总数  
- $n_t$：包含词项 $t$ 的文档数  

---

## 3. BM25 的直观理解

- **TF 部分**：词频越高，分数越大，但存在 **饱和效应**  
- **IDF 部分**：词越稀有（在少数文档中出现），分数越大  
- **长度归一化**：短文档更容易获得高分，避免长文档因词多而得分过高  

---

## 4. BM25 的优缺点

### 优点
- 经典且稳定，效果优于 TF-IDF  
- 适合文本稀疏检索（倒排索引）  
- 在搜索引擎（Lucene、ElasticSearch）中是默认算法  

### 缺点
- 只基于词项匹配，无法捕捉 **语义相似**（同义词、上下文关系）  
- 对拼写错误、同义改写不鲁棒  
- 难以处理多语言、子词等复杂情况  

---

## 5. 工程实践

- **超参数调优**：  
  - $$k_1 \in [1.2, 2.0]$$  
  - $$b \in [0.5, 0.9]$$  
  - 通常使用默认值 $$k_1 = 1.5, b = 0.75$$ 就有不错效果  

- **应用场景**：  
  - 传统搜索引擎（Lucene, ElasticSearch, Whoosh）  
  - 稀疏检索与稠密检索混合（Hybrid Search）  
  - 作为 **候选生成阶段**，后续可用 ANN + Rerank 精排  

---

## 6. 与稠密检索的结合

- **稀疏检索 (BM25)**：可解释性强，关键词覆盖好  
- **稠密检索 (Embeddings)**：语义泛化能力强，召回效果更好  
- **Hybrid Search**：BM25 + 向量检索结合，效果通常优于单一方法  

---

## 7. 总结

- **BM25 是 [[TF-IDF]] 的改进版本**，在搜索引擎中依然广泛使用  
- 核心改进：TF 饱和 + 文档长度归一化 + 改进的 IDF  
- **适合关键词匹配**，但难以处理语义相似问题  
- 在现代系统中，常作为 **稀疏检索的基线方法**，结合 [[ANN]] / [[Rerank]] 构建完整检索系统  

---
