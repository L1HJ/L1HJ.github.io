## 1. 引言
在向量检索中，我们常常需要找到与查询向量最近的邻居。  
**精确最近邻 (Exact Nearest Neighbor)** 的复杂度为：

$$
O(N \cdot d)
$$

其中：
- $N$ = 向量库大小  
- $d$ = 向量维度  

当 $N$ 达到百万甚至上亿时，暴力搜索不可行。  
因此提出 **近似最近邻搜索 (ANN)** ——允许牺牲少量精度，换取数量级的速度提升。

---

## 2. 基本思想

ANN 的核心目标：

- 在 **高维空间** 中快速找到 **Top-K 近似邻居**  
- 保持较高的 **召回率 (Recall)**  
- 在速度和精度之间平衡

---

## 3. 常见的 ANN 方法

### 3.1 基于量化 (Quantization)
- **PQ (Product Quantization)**：将向量分片，每个子向量量化到一个中心  
- **OPQ (Optimized PQ)**：在 PQ 前增加线性变换，减少信息损失  
- **IVF-PQ**：聚类 + 量化结合  
- 优点：节省存储，查询速度快  
- 缺点：存在量化误差  

### 3.2 基于树结构
- **KD-Tree**  
  - 适合低维数据 (d < 20)  
  - 高维时效率迅速下降（维度灾难）  

- **Ball-Tree**  
  - 使用球体分区空间  
  - 同样在高维时性能有限  

### 3.3 基于图 (Graph-based ANN)
- **HNSW (Hierarchical Navigable Small World)**  
  - 构建小世界图  
  - 查询复杂度接近对数级  
  - 高精度 + 高速度  
  - 目前最流行的 ANN 算法之一  

### 3.4 基于哈希 (Hashing)
- **LSH (Locality Sensitive Hashing)**  
  - 将相似向量映射到相同哈希桶的概率较大  
  - 适合欧式距离和余弦相似度  
  - 精度通常不如 HNSW / PQ  

---

## 4. 工程中常用的 ANN 库

- **Faiss (Meta AI)**  
  - 支持 GPU  
  - 提供 Flat, IVF, PQ, HNSW 等多种索引  
  - 适合大规模工业应用  

- **hnswlib**  
  - 高效的 HNSW 实现  
  - Python/C++ 接口，易用  

- **Annoy (Spotify)**  
  - 基于树的 ANN  
  - 内存友好，适合离线场景  

- **Milvus / Weaviate**  
  - 向量数据库，内置多种 ANN 索引  
  - 适合大规模在线服务  

---

## 5. 关键评估指标

在选择 ANN 算法时，常用指标包括：

- **Recall@K**  
  - 衡量近似结果与精确结果的重合度  
  $$
  \text{Recall@K} = \frac{| \text{Top-K(ANN)} \cap \text{Top-K(Exact)} |}{K}
  $$

- **查询延迟 (Latency)**  
  - 单次查询所需时间  

- **内存占用 (Memory Usage)**  
  - 索引构建后消耗的内存  

- **构建时间 (Build Time)**  
  - 索引构建所需的时间  

---

## 6. 工程实践建议

- 数据规模 **小于 10 万**：可以直接使用 **精确搜索 (Flat)**  
- 数据规模 **百万级**：推荐 **IVF 或 HNSW**  
- 数据规模 **亿级以上**：建议 **IVF-PQ / OPQ**（节省存储）  
- 如果需要 **GPU 加速**：优先考虑 **Faiss**  
- 如果追求 **高精度**：优先选择 **HNSW**  

---

## 7. 应用场景

- **搜索引擎**：大规模文档的语义检索  
- **推荐系统**：用户/物品 embedding 的快速匹配  
- **问答系统**：候选答案的 Top-K 检索  
- **图像检索**：相似图像/视频查找  
- **多模态搜索**：跨模态 embedding 检索（文本-图像匹配）  

---

## 8. 总结

- **ANN** 是大规模向量检索的核心技术  
- 常见方法：量化 (PQ)、树结构、图结构 (HNSW)、哈希 (LSH)  
- **HNSW** 和 **IVF-PQ** 是当前工业界最常用的方案  
- 工程上要在 **召回率、速度、存储** 之间权衡  
- 最佳实践：  
  - **召回阶段**：ANN（快速找到候选）  
  - **Rerank 阶段**：精细模型（Cross-Encoder）进行重排序  

---
