## 1. 引言
在向量检索中，暴力搜索的时间复杂度为：
$$
O(N \cdot d)
$$
其中 $N$ 是向量库大小，$d$ 是向量维度。  当 $N$ 达到百万、甚至上亿时，暴力搜索不可行。  

**Faiss (Facebook AI Similarity Search)** 是一个由 Meta AI 开发的高性能库，专门用于 **高维向量的相似度搜索和聚类**。  
它支持 **CPU/GPU 加速**，并内置多种索引方法，已经成为工业界标准方案。

---

## 2. 基本功能

Faiss 提供以下核心功能：

- **相似度搜索 (Similarity Search)**  
  支持余弦相似度、欧式距离、内积等  

- **聚类 (Clustering)**  
  内置 K-means 等高效聚类算法  

- **降维 (PCA, OPQ, PQ)**  
  用于减少存储和加快搜索  

- **索引结构**  
  提供从精确搜索到近似搜索的多种索引

---

## 3. 常见索引类型

### 3.1 Flat 索引（精确搜索）
- `IndexFlatL2`：欧式距离  
- `IndexFlatIP`：内积  

存储全部向量，检索复杂度 $$O(N \cdot d)$$，适合小规模数据集。

---

### 3.2 IVF 索引（倒排文件）
- 思路：将向量聚类（K-means），只在相关簇内搜索  
- 典型实现：`IndexIVFFlat`  

查询复杂度近似为：

$$
O\left(\frac{N}{n_{\text{list}}} \cdot d\right)
$$

其中 $$n_{\text{list}}$$ 是聚类簇的数量。  
适合 **中等规模**（百万级）的向量库。

---

### 3.3 PQ / OPQ（量化）
- **PQ (Product Quantization)**：将向量分片并量化，极大减少存储  
- **OPQ (Optimized PQ)**：在 PQ 前加线性变换，效果更好  
- 常见组合：`IndexIVFPQ`  
- 内存占用显著减少，适合 **超大规模**（亿级）场景

---

### 3.4 HNSW 索引
- Faiss 内部也支持 `IndexHNSWFlat`，与 hnswlib 类似  
- 更适合需要高精度 ANN 的场景

---

## 4. 搜索流程

1. **向量预处理**（可选）  
   - 归一化（适合余弦相似度）  
   - 降维（PCA）  

2. **选择索引类型**  
   - 小数据集：Flat  
   - 中等规模：IVF  
   - 大规模：IVF + PQ  

3. **训练索引**（针对 IVF/PQ 索引）  
   - 使用样本数据进行 K-means 训练  

4. **添加向量**  
   - `index.add(xb)`  

5. **查询**  
   - `index.search(xq, k)` 返回 top-k 近邻  

---

## 5. 关键参数

- **nlist**：聚类簇数量（影响召回率和速度）  
- **nprobe**：查询时搜索的簇数（越大精度越高，但速度更慢）  
- **M**：HNSW 每个节点的连接数  
- **code_size**：PQ 每个子向量的编码长度

---

## 6. 工程特点

- **优点**：
  - 支持 **CPU/GPU**，性能极高  
  - 提供多种索引类型，可灵活选择  
  - 社区活跃，工业界应用广泛  

- **缺点**：
  - API 上手门槛略高  
  - IVF/PQ 等索引需要训练步骤  
  - 大规模索引构建需要大量内存

---

## 7. 应用场景

- **推荐系统**：大规模 embedding 召回  
- **搜索引擎**：文本/图片向量检索  
- **NLP**：语义检索、问答系统  
- **计算机视觉**：相似图像/视频查找  

---

## 8. 工程实践建议

- 小规模（<10万）：`IndexFlatL2`  
- 百万级：`IndexIVFFlat` 或 `IndexHNSWFlat`  
- 亿级以上：`IndexIVFPQ` + GPU  

**调参建议**：
- 先设定 $$nlist \approx \sqrt{N}$$  
- 调整 $$nprobe$$ 平衡精度与速度  
- 大规模数据一定要考虑 PQ/OPQ 压缩

---

## 9. 总结

- Faiss 是当前最成熟的向量检索库之一  
- 索引选择要结合数据规模与精度需求  
- IVF + PQ 是大规模检索的主流方案  
- 与 HNSW、Annoy 等方法相比，Faiss 更适合在 **GPU 加速、大规模检索** 的工业环境中使用  

---
